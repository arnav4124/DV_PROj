<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Sales Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f6f8fd 0%, #f1f4f9 100%);
        min-height: 100vh;
        padding: 2rem;
        color: #2d3748;
      }

      .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 2.5rem;
      }

      .dashboard-header {
        margin-bottom: 3rem;
        text-align: center;
      }

      .dashboard-header h1 {
        color: #1a202c;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        background: linear-gradient(120deg, #2c5282, #4299e1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .dashboard-header p {
        color: #718096;
        font-size: 1.2rem;
        font-weight: 400;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 3rem;
      }

      select {
        padding: 0.75rem 2rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        background-color: white;
        color: #2d3748;
        cursor: pointer;
        transition: all 0.2s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%232d3748' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1em;
      }

      select:hover {
        border-color: #cbd5e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      select:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
      }

      .visualization-container {
        position: relative;
        margin-top: 2rem;
        padding: 1.5rem;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
      }

      .axis-label {
        font-size: 0.875rem;
        fill: #4a5568;
        font-weight: 500;
      }

      .x-axis path,
      .y-axis path {
        stroke: #e2e8f0;
      }

      .x-axis line,
      .y-axis line {
        stroke: #edf2f7;
      }

      .x-axis text,
      .y-axis text {
        fill: #718096;
        font-size: 0.75rem;
      }

      .trend-line {
        stroke-dasharray: 4, 4;
      }

      .total-line {
        stroke: #f6ad55;
        stroke-width: 3;
        fill: none;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      }

      .tooltip {
        position: absolute;
        padding: 1rem;
        background: rgba(26, 32, 44, 0.95);
        color: white;
        border-radius: 8px;
        font-size: 0.875rem;
        pointer-events: none;
        z-index: 100;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        max-width: 300px;
        line-height: 1.5;
      }

      .legend {
        font-size: 0.875rem;
        font-weight: 500;
      }

      .legend text {
        fill: #4a5568;
      }

      .legend rect {
        rx: 3;
      }

      /* Beautiful color palette for bars */
      .budget-bar {
        fill: #48bb78;
      }
      .midrange-bar {
        fill: #38b2ac;
      }
      .luxury-bar {
        fill: #2b6cb0;
      }

      /* Hover effects */
      rect:hover {
        filter: brightness(1.1);
        transition: filter 0.2s ease;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1>Car Sales Analysis Dashboard</h1>
        <p>Monthly sales distribution across different price ranges</p>
      </div>
      <div class="controls">
        <select id="yearSelect"></select>
      </div>
      <div id="visualization" class="visualization-container"></div>
    </div>

    <script>
      // Create SVG container
      const margin = { top: 40, right: 160, bottom: 60, left: 70 };
      const width = 960 - margin.left - margin.right;
      const height = 500 - margin.top - margin.bottom;

      const svg = d3
        .select("#visualization")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // Create tooltip div
      const tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      // Process the data
      function processData(data, selectedYear) {
        // Filter by year using the year column directly
        const yearData = data.filter((d) => d.year1 === selectedYear);

        // Create price ranges
        const priceRanges = [
          { min: 0, max: 20000, label: "Budget (<$20k)" },
          { min: 20000, max: 35000, label: "Mid ($20k-$35k)" },
          { min: 35000, max: Infinity, label: "Luxury (>$35k)" },
        ];

        // Create a map for month names to numbers
        const monthToNum = {
          Jan: 0,
          Feb: 1,
          Mar: 2,
          Apr: 3,
          May: 4,
          Jun: 5,
          Jul: 6,
          Aug: 7,
          Sep: 8,
          Oct: 9,
          Nov: 10,
          Dec: 11,
        };

        // Initialize empty month data for all months
        let monthData = {};
        for (let i = 0; i < 12; i++) {
          monthData[i] = {
            month: i,
            "Budget (<$20k)": 0,
            "Mid ($20k-$35k)": 0,
            "Luxury (>$35k)": 0,
            total: 0,
          };
        }

        // Process each sale
        yearData.forEach((d) => {
          const monthNum = monthToNum[d.month];
          const price = parseFloat(d.sellingprice);

          // Find appropriate price range
          const priceRange = priceRanges.find(
            (range) => price >= range.min && price < range.max
          );

          // Increment the count for this price range and month
          if (monthData[monthNum]) {
            monthData[monthNum][priceRange.label]++;
            monthData[monthNum].total++;
          }
        });

        // Convert to array
        return Object.values(monthData);
      }

      // Set up scales
      const x0 = d3
        .scaleBand()
        .domain(d3.range(12))
        .range([0, width])
        .padding(0.1);

      const x1 = d3
        .scaleBand()
        .domain(["Budget (<$20k)", "Mid ($20k-$35k)", "Luxury (>$35k)"])
        .padding(0.05);

      const y = d3.scaleLinear().range([height, 0]);

      const color = d3
        .scaleOrdinal()
        .domain(["Budget (<$20k)", "Mid ($20k-$35k)", "Luxury (>$35k)"])
        .range(["#74c476", "#31a354", "#006d2c"]);

      // Add axes
      const xAxis = d3
        .axisBottom(x0)
        .tickFormat(
          (d) =>
            [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ][d]
        );

      const yAxis = d3.axisLeft(y);

      svg
        .append("g")
        .attr("class", "x-axis")
        .attr("transform", `translate(0,${height})`);

      svg.append("g").attr("class", "y-axis");

      // Add labels
      svg
        .append("text")
        .attr("class", "axis-label")
        .attr("transform", "rotate(-90)")
        .attr("y", -margin.left)
        .attr("x", -height / 2)
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Number of Cars Sold");

      function updateVisualization(data, selectedYear) {
        const processedData = processData(data, selectedYear);

        // Update scales
        x1.range([0, x0.bandwidth()]);
        y.domain([0, d3.max(processedData, (d) => d.total)]);

        // Update axes
        svg.select(".x-axis").transition().duration(750).call(xAxis);

        svg.select(".y-axis").transition().duration(750).call(yAxis);

        // Create groups for each month
        const monthGroup = svg
          .selectAll(".month")
          .data(processedData)
          .join("g")
          .attr("class", "month")
          .attr("transform", (d) => `translate(${x0(d.month)},0)`);

        // Add bars for each price range
        const priceRanges = [
          "Budget (<$20k)",
          "Mid ($20k-$35k)",
          "Luxury (>$35k)",
        ];

        monthGroup
          .selectAll("rect")
          .data((d) =>
            priceRanges.map((range) => ({
              range,
              value: d[range] || 0,
              month: d.month,
              total: d.total,
            }))
          )
          .join("rect")
          .attr("x", (d) => x1(d.range))
          .attr("y", (d) => y(d.value))
          .attr("width", x1.bandwidth())
          .attr("height", (d) => height - y(d.value))
          .attr("fill", (d) => color(d.range))
          .on("mouseover", function (event, d) {
            const months = [
              "January",
              "February",
              "March",
              "April",
              "May",
              "June",
              "July",
              "August",
              "September",
              "October",
              "November",
              "December",
            ];
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip
              .html(
                `
                        <strong>${months[d.month]} ${selectedYear}</strong><br/>
                        ${d.range}: ${d.value} cars<br/>
                        Total: ${d.total} cars
                    `
              )
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseout", function () {
            tooltip.transition().duration(500).style("opacity", 0);
          });

        // Add total sales line
        const line = d3
          .line()
          .x((d) => x0(d.month) + x0.bandwidth() / 2)
          .y((d) => y(d.total))
          .curve(d3.curveMonotoneX);

        svg
          .selectAll(".total-line")
          .data([processedData])
          .join("path")
          .attr("class", "total-line")
          .transition()
          .duration(750)
          .attr("d", line);

        // Update legend
        const legend = svg
          .selectAll(".legend")
          .data([...priceRanges, "Total Sales"])
          .join("g")
          .attr("class", "legend")
          .attr("transform", (d, i) => `translate(${width + 10},${i * 20})`);

        legend
          .selectAll("rect")
          .data((d) => [d])
          .join("rect")
          .attr("x", 0)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", (d) => (d === "Total Sales" ? "#ff7f0e" : color(d)));

        legend
          .selectAll("text")
          .data((d) => [d])
          .join("text")
          .attr("x", 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style("text-anchor", "start")
          .text((d) => d);
      }

      // Load and process the CSV data
      d3.csv("car_prices_processed2.csv")
        .then((data) => {
          // Get unique years from the data
          const years = [...new Set(data.map((d) => d.year1))].sort();
          console.log(years);

          // Populate year select dropdown
          const yearSelect = d3.select("#yearSelect");
          yearSelect.selectAll("option").remove(); // Clear existing options

          years.forEach((year) => {
            yearSelect.append("option").attr("value", year).text(year);
          });

          // Initial visualization with the most recent year
          const latestYear = years[years.length - 1];
          yearSelect.property("value", latestYear);
          updateVisualization(data, latestYear);

          // Update on year selection
          yearSelect.on("change", function () {
            updateVisualization(data, this.value);
          });
        })
        .catch((error) => {
          console.error("Error loading the CSV file:", error);
          d3.select("#visualization")
            .append("div")
            .attr("class", "error")
            .text(
              "Error loading data. Please make sure car_prices.csv is in the correct location."
            );
        });
    </script>
  </body>
</html>
