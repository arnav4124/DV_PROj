<!DOCTYPE html>
<html>
<head>
    <title>US Vehicle Odometer Analysis</title>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .heading {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0;
            animation: slideDown 0.8s ease forwards;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 18px;
            color: #34495e;
        }

        #map {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px auto;
        }

        .state {
            stroke: #fff;
            stroke-width: 1px;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .state:hover {
            stroke-width: 2px;
            filter: brightness(0.9);
            cursor: pointer;
            transform: translateY(-2px);
        }

        .tooltip {
            position: absolute;
            padding: 12px 15px;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            pointer-events: none;
            font-size: 14px;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .legend {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="heading">
            <div class="title">Vehicle Odometer Readings Across United States</div>
            <div class="subtitle">Analysis of Total Miles Driven by State</div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script>
        const width = 960;
        const height = 600;
        
        const svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [-140,0 , width, height])
            .attr("style", "max-width: 100%; height: auto;");
            
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        const projection = d3.geoAlbersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);
            
        const path = d3.geoPath()
            .projection(projection);

        Promise.all([
            d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
            d3.csv("car_data_full_states.csv")
        ]).then(function(data) {
            const us = data[0];
            const carData = data[1];
            
            const stateData = d3.group(carData, d => d.state);
            const odometerByState = new Map();
            
            for (let [state, values] of stateData) {
                const totalOdometer = d3.sum(values, d => +d.odometer);
                odometerByState.set(state, totalOdometer);
            }
            
            const colorScale = d3.scaleQuantile()
                .domain([...odometerByState.values()])
                .range(d3.schemeBlues[9]);
            
            svg.append("g")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .join("path")
                .attr("class", "state")
                .attr("d", path)
                .style("fill", d => {
                    const stateName = d.properties.name;
                    return odometerByState.has(stateName) 
                        ? colorScale(odometerByState.get(stateName)) 
                        : "#ccc";
                })
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    
                    const stateName = d.properties.name;
                    const odometerReading = odometerByState.get(stateName);
                    
                    tooltip.html(`
                        <strong>${stateName}</strong><br/>
                        Total Miles: ${odometerReading ? 
                            d3.format(",")(Math.round(odometerReading)) : "No data"}
                    `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Legend
            const legendGroup = svg.append("g")
                .attr("class", "legend")
                .attr("transform", "translate(20,20)");

            const legendData = colorScale.range().map(d => {
                const [min, max] = colorScale.invertExtent(d);
                return { color: d, min: min, max: max };
            });

            const legendItems = legendGroup.selectAll("g")
                .data(legendData)
                .join("g")
                .attr("transform", (d, i) => `translate(0,${i * 20})`);

            legendItems.append("rect")
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", d => d.color);

            legendItems.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", "0.35em")
                .text(d => `${d3.format(".0s")(d.min)} - ${d3.format(".0s")(d.max)}`);
        });
    </script>
</body>
</html>